
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>대피 3단계 게임 - 낮은자세/젖은수건/계단</title>
<style>
  html,body{margin:0;height:100%;background:#cfefff;font-family:system-ui,'Noto Sans KR',sans-serif}
  #app{position:fixed;inset:0;overflow:hidden;background:#cfefff}
  .stage{position:absolute;inset:0;display:none}
  .stage.active{display:block}
  .bg{position:absolute;inset:0;width:100vw;height:100vh;object-fit:cover}
  .next{position:absolute;right:2.5vw;top:2.5vh;width:min(12vw,80px);height:auto;display:none;cursor:pointer;z-index:5}
  .ring{position:absolute;width:22vmin;height:22vmin;border:9px solid rgba(255,64,64,.95);border-radius:50%;pointer-events:none;transform:translate(-50%,-50%);box-shadow:0 0 0 8px rgba(255,64,64,.15);animation:pop .18s ease-out;z-index:4}
  @keyframes pop{from{transform:translate(-50%,-50%) scale(.7);opacity:.5}to{transform:translate(-50%,-50%) scale(1);opacity:1}}
  .hint{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.45);color:#fff;padding:8px 10px;border-radius:10px;font-size:13px;z-index:6}
  /* Stage2 layout */
  #s2 .wrap{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;padding:6vmin 8vmin;gap:6vmin}
  #girl{flex:0 0 56%;max-height:86vh;object-fit:contain}
  #towel{flex:0 0 26%;max-height:40vh;object-fit:contain;touch-action:none;cursor:grab}
  #towel.dragging{opacity:.85;cursor:grabbing}
  #towelOk{position:absolute;display:none;pointer-events:none}
  /* Final message */
  .final{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:7}
  .final .box{background:#fff;border-radius:16px;padding:20px 26px;font-size:22px;font-weight:700;color:#2d3748;box-shadow:0 10px 30px rgba(0,0,0,.25)}
</style>
</head>
<body>
<div id="app">
  <!-- Stage 1: 낮은자세 배경 -->
  <section id="s1" class="stage active">
    <img id="bg1" class="bg" src="assets/s1_bg.webp" alt="낮은자세">
    <img id="next1" class="next" src="assets/arrow.png" alt="다음">
    <div class="hint">낮은 자세 그림을 골라 톡!</div>
  </section>

  <!-- Stage 2: 빈 배경 + 드래그 앤 드롭 -->
  <section id="s2" class="stage">
    <img class="bg" src="assets/blank.webp" alt="빈 배경">
    <div class="wrap">
      <img id="girl" src="assets/lowpose_girl.webp" alt="낮은자세 그림">
      <img id="towel" src="assets/towel.webp" alt="젖은수건(드래그)">
    </div>
    <img id="towelOk" src="assets/towel_ok.webp" alt="젖은수건 정답">
    <img id="next2" class="next" src="assets/arrow.png" alt="다음">
    <div class="hint">젖은 수건을 드래그해서 입과 코를 막아줘!</div>
  </section>

  <!-- Stage 3: 계단/엘베 배경 -->
  <section id="s3" class="stage">
    <img id="bg3" class="bg" src="assets/stairs.webp" alt="계단/엘리베이터">
    <img id="next3" class="next" src="assets/arrow.png" alt="끝">
    <div class="hint">계단을 선택해요!</div>
  </section>

  <div id="final" class="final"><div class="box">모두 정답입니다!</div></div>

  <audio id="ok" src="assets/correct.mp3" preload="auto"></audio>
</div>

<script>
// ======= 공통 유틸 =======
function mapToDisplayed(imgEl, xPct, yPct){
  const natW=imgEl.naturalWidth||1000, natH=imgEl.naturalHeight||1000, imgR=natW/natH;
  const r=imgEl.getBoundingClientRect(), boxW=r.width, boxH=r.height, boxR=boxW/boxH;
  let drawW,drawH,ox=0,oy=0;
  if(boxR>imgR){ drawH=boxH; drawW=drawH*imgR; ox=(boxW-drawW)/2; } else { drawW=boxW; drawH=drawW/imgR; oy=(boxH-drawH)/2; }
  const x=r.left+ox+(xPct/100)*drawW, y=r.top+oy+(yPct/100)*drawH;
  const short=Math.min(drawW,drawH);
  return {x,y,short,drawW,drawH,left:r.left+ox,top:r.top+oy};
}
function showRing(stageEl, x, y){
  const ring=document.createElement('div'); ring.className='ring';
  ring.style.left=x+'px'; ring.style.top=y+'px'; stageEl.appendChild(ring);
}
function pointerXY(e){ if(e.touches && e.touches[0]) return {x:e.touches[0].clientX, y:e.touches[0].clientY}; if(e.changedTouches && e.changedTouches[0]) return {x:e.changedTouches[0].clientX, y:e.changedTouches[0].clientY}; return {x:e.clientX, y:e.clientY}; }
function playOK(){ try{ const a=document.getElementById('ok'); a.currentTime=0; a.play(); }catch(_){} }

// ======= 1단계: 낮은자세 배경에서 그림 영역 터치 =======
// 핫스팟: 예시(3197) 기준 비율로 박스 지정
const S1_BOX = { x:25, y:36, w:37, h:56 }; // 좌상단 x,y, 폭, 높이 (%)
(function(){
  const stage = document.getElementById('s1');
  const bg = document.getElementById('bg1');
  const next = document.getElementById('next1');
  const handler=(e)=>{
    const p=pointerXY(e);
    // 박스 판정
    const m = mapToDisplayed(bg, S1_BOX.x, S1_BOX.y);
    const px = m.left + (S1_BOX.w/100)*m.drawW;
    // 실제 좌표 범위
    const left = m.left, top = m.top;
    const right = m.left + (S1_BOX.x+S1_BOX.w)/100*m.drawW - (S1_BOX.x/100*m.drawW);
    // 더 간단히:
    const x1 = m.left + (S1_BOX.x/100)*m.drawW;
    const y1 = m.top  + (S1_BOX.y/100)*m.drawH;
    const x2 = x1 + (S1_BOX.w/100)*m.drawW;
    const y2 = y1 + (S1_BOX.h/100)*m.drawH;
    if(p.x>=x1 && p.x<=x2 && p.y>=y1 && p.y<=y2){
      playOK(); showRing(stage, p.x, p.y);
      next.style.display='block';
      next.onclick=()=>{ stage.classList.remove('active'); document.getElementById('s2').classList.add('active'); next.style.display='none'; };
      stage.removeEventListener('pointerdown', handler);
      stage.removeEventListener('touchstart', handler);
      stage.removeEventListener('click', handler);
    }
  };
  stage.addEventListener('pointerdown', handler);
  stage.addEventListener('touchstart', handler, {passive:true});
  stage.addEventListener('click', handler);
})();

// ======= 2단계: 드래그 앤 드롭 =======
(function(){
  const stage = document.getElementById('s2');
  const girl = document.getElementById('girl');
  const towel = document.getElementById('towel');
  const towelOk = document.getElementById('towelOk');
  const next = document.getElementById('next2');

  let dragging=false, offX=0, offY=0;

  function onDown(e){
    const p = pointerXY(e);
    const r = towel.getBoundingClientRect();
    dragging = true; towel.classList.add('dragging');
    offX = p.x - r.left; offY = p.y - r.top;
    towel.style.position='absolute'; towel.style.zIndex='6';
    moveAt(p.x, p.y);
  }
  function moveAt(x,y){
    towel.style.left = (x - offX) + 'px';
    towel.style.top  = (y - offY) + 'px';
  }
  function onMove(e){ if(!dragging) return; const p=pointerXY(e); moveAt(p.x,p.y); }
  function onUp(e){
    if(!dragging) return;
    dragging=false; towel.classList.remove('dragging');
    // drop check near mouth/hand area of girl
    // 박스 비율 (그림의 오른쪽 얼굴 하단 부분) - 비율 조정 쉬운 상수
    const TARGET = { x:61, y:56, w:18, h:18 }; // % of girl image box
    const g = girl.getBoundingClientRect();
    const gx=g.left, gy=g.top, gw=g.width, gh=g.height;
    const x1 = gx + (TARGET.x/100)*gw;
    const y1 = gy + (TARGET.y/100)*gh;
    const x2 = x1 + (TARGET.w/100)*gw;
    const y2 = y1 + (TARGET.h/100)*gh;
    const t = towel.getBoundingClientRect();
    const cx = t.left + t.width/2, cy = t.top + t.height/2;
    if(cx>=x1 && cx<=x2 && cy>=y1 && cy<=y2){
      // 성공: 정답 이미지 오버레이
      towel.style.display='none';
      towelOk.style.display='block';
      // 정답이미지 크기/위치: TARGET 영역을 꽉 채우되 여백 조금
      const pad = 0.06; // 6% 패딩
      const ox = gx + (TARGET.x/100)*gw + (pad*(TARGET.w/100)*gw);
      const oy = gy + (TARGET.y/100)*gh + (pad*(TARGET.h/100)*gh);
      const ow = (TARGET.w/100)*gw * (1-2*pad);
      const oh = (TARGET.h/100)*gh * (1-2*pad);
      towelOk.style.left = ox+'px'; towelOk.style.top = oy+'px';
      towelOk.style.width = ow+'px'; towelOk.style.height = 'auto';
      playOK();
      next.style.display='block';
      next.onclick=()=>{ stage.classList.remove('active'); document.getElementById('s3').classList.add('active'); next.style.display='none'; };
      // remove listeners
      document.removeEventListener('pointermove', onMove);
      document.removeEventListener('pointerup', onUp);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onUp);
    }
  }

  towel.addEventListener('pointerdown', onDown);
  document.addEventListener('pointermove', onMove);
  document.addEventListener('pointerup', onUp);
  // touch safety
  towel.addEventListener('touchstart', onDown, {passive:true});
  document.addEventListener('touchmove', onMove);
  document.addEventListener('touchend', onUp);
})();

// ======= 3단계: 계단 선택 =======
// 계단 영역 박스 (% of bg3)
const STAIR_BOX = { x:59, y:37, w:22, h:54 };
(function(){
  const stage = document.getElementById('s3');
  const bg = document.getElementById('bg3');
  const final = document.getElementById('final');
  const next = document.getElementById('next3'); // not used but kept for symmetry
  const handler=(e)=>{
    const p=pointerXY(e);
    const m=mapToDisplayed(bg, STAIR_BOX.x, STAIR_BOX.y);
    const x1 = m.left + (STAIR_BOX.x/100)*m.drawW;
    const y1 = m.top  + (STAIR_BOX.y/100)*m.drawH;
    const x2 = x1 + (STAIR_BOX.w/100)*m.drawW;
    const y2 = y1 + (STAIR_BOX.h/100)*m.drawH;
    if(p.x>=x1 && p.x<=x2 && p.y>=y1 && p.y<=y2){
      playOK(); showRing(stage, p.x, p.y);
      final.style.display='flex';
      stage.removeEventListener('pointerdown', handler);
      stage.removeEventListener('touchstart', handler);
      stage.removeEventListener('click', handler);
    }
  };
  stage.addEventListener('pointerdown', handler);
  stage.addEventListener('touchstart', handler, {passive:true});
  stage.addEventListener('click', handler);
})();
</script>
</body>
</html>
