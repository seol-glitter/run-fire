<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>대피 3단계 게임</title>
<style>
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(#cfefff,#e9f7ff)}
  #app{position:relative; width:100vw; height:100vh; overflow:hidden}
  .stage{position:absolute; inset:0; display:none}
  .stage.active{display:block}
  .bg{position:absolute; inset:0; background-size:contain; background-position:center center; background-repeat:no-repeat}
  .card{position:absolute; left:8vw; top:8vh; width:55vw; height:78vh; background-size:contain; background-position:left top; background-repeat:no-repeat}
  .next{position:absolute; right:3vw; top:3vh; width:64px; height:64px; background:url('assets/arrow.png') center/contain no-repeat; display:none; cursor:pointer; z-index:10}
  .circle{position:absolute; width:20vw; height:20vw; border:14px solid rgba(255,80,90,.85); border-radius:50%; pointer-events:none; transform:translate(-50%,-50%); box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .drag{position:absolute; right:8vw; bottom:10vh; width:min(28vw,320px); touch-action:none; user-select:none; cursor:grab}
  .msg{position:absolute; left:50%; bottom:2vh; transform:translateX(-50%); background:rgba(0,0,0,.55); color:#fff; font:600 16px/1.4 Pretendard,system-ui,Apple SD Gothic Neo,sans-serif; padding:10px 14px; border-radius:10px}
  /* Stage specific */
  #s2 .card{left:8vw; top:10vh; width:min(56vw,740px); height:min(76vh,820px)}
  #s3 .bg{background-size:cover}
</style>
</head>
<body>
<div id="app">
  <!-- Stage 1: 낮은자세 전체 카드 클릭 -->
  <section id="s1" class="stage active">
    <div class="bg" style="background-image:url('assets/낮은자세.png')"></div>
    <div class="card hit1" aria-label="낮은자세 그림" style="background-image:url('assets/낮은자세_그림.png')"></div>
    <div class="next next1" title="다음 단계로"></div>
  </section>

  <!-- Stage 2: 수건 드래그 → 카드 전체 드롭, 정답 이미지 오버레이 -->
  <section id="s2" class="stage">
    <div class="bg" style="background-image:url('assets/빈화면.png')"></div>
    <div class="card dropzone" style="background-image:url('assets/낮은자세_그림.png')"></div>
    <img class="drag towel" src="assets/젖은수건.png" alt="젖은 수건 끌어놓기" />
    <img class="answer" src="assets/젖은수건_정답.png"
         style="position:absolute; opacity:0; pointer-events:none;"
         alt="정답 수건"/>
    <div class="next next2" title="다음 단계로"></div>
  </section>

  <!-- Stage 3: 계단/엘베 선택 - 계단 전체 박스 -->
  <section id="s3" class="stage">
    <div class="bg" style="background-image:url('assets/계단_엘베.png')"></div>
    <div class="next next3" style="display:none"></div>
  </section>

  <div class="circle" id="circle" style="display:none"></div>
  <audio id="snd" src="assets/correct.wav" preload="auto"></audio>
  <div class="msg" id="hint" style="display:none"></div>
</div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const app = $('#app');
  const circle = $('#circle');
  const snd = $('#snd');
  const hint = $('#hint');

  function showCircleAt(px, py, scale=1){
    const size = Math.min(window.innerWidth, window.innerHeight) * 0.40 * scale; // enlarged (2x from before)
    circle.style.width = size + 'px';
    circle.style.height = size + 'px';
    circle.style.left = px + 'px';
    circle.style.top = py + 'px';
    circle.style.display = 'block';
    setTimeout(()=>circle.style.display='none', 1500);
  }
  function playCorrect(){ try{ snd.currentTime=0; snd.play(); }catch(e){} }
  function next(el){ el.style.display='block'; el.onclick=()=>goto(el.parentElement.id==='s1'?'s2':'s3'); }

  function goto(id){
    document.querySelectorAll('.stage').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // Stage 1
  const s1Card = document.querySelector('#s1 .hit1');
  const s1Next = document.querySelector('#s1 .next1');
  s1Card.addEventListener('click', (e)=>{
    const r = s1Card.getBoundingClientRect();
    showCircleAt(r.left + r.width*0.55, r.top + r.height*0.55, 1.0);
    playCorrect();
    next(s1Next);
  }, {passive:true});

  // Stage 2
  const s2 = document.getElementById('s2');
  const drop = document.querySelector('#s2 .dropzone');
  const towel = document.querySelector('#s2 .towel');
  const ans = document.querySelector('#s2 .answer');
  const s2Next = document.querySelector('#s2 .next2');

  let dragging=false, dx=0, dy=0;
  function pos(e){
    if(e.touches && e.touches[0]) return {x:e.touches[0].clientX, y:e.touches[0].clientY};
    return {x:e.clientX, y:e.clientY};
  }
  function onDown(e){
    dragging=true; towel.style.cursor='grabbing';
    const p = pos(e), r = towel.getBoundingClientRect();
    dx = p.x - r.left; dy = p.y - r.top;
    e.preventDefault();
  }
  function onMove(e){
    if(!dragging) return;
    const p = pos(e);
    towel.style.left = (p.x - dx) + 'px';
    towel.style.top  = (p.y - dy) + 'px';
    towel.style.position='absolute';
  }
  function onUp(e){
    if(!dragging) return;
    dragging=false; towel.style.cursor='grab';
    const p = pos(e);
    const dr = drop.getBoundingClientRect();
    // Drop success when released inside the entire card
    if(p.x>=dr.left && p.x<=dr.right && p.y>=dr.top && p.y<=dr.bottom){
      // Place the answer image at the mouth/nose position (tuned offsets)
      // Calculate absolute position using drop rect
      const ax = dr.left + dr.width * 0.56; // ~ slightly right of center of face
      const ay = dr.top  + dr.height* 0.58; // ~ mouth/nose area
      ans.style.left = (ax - dr.width*0.20) + 'px'; // width offset
      ans.style.top  = (ay - dr.height*0.26) + 'px'; // height offset
      ans.style.width = (dr.width*0.38) + 'px';
      ans.style.opacity = 1;
      // Snap towel near answer for visual clarity
      towel.style.left = (ax - 40) + 'px';
      towel.style.top  = (ay + 30) + 'px';
      playCorrect();
      next(s2Next);
    }
  }
  towel.addEventListener('mousedown', onDown);
  towel.addEventListener('touchstart', onDown, {passive:false});
  window.addEventListener('mousemove', onMove, {passive:false});
  window.addEventListener('touchmove', onMove, {passive:false});
  window.addEventListener('mouseup', onUp);
  window.addEventListener('touchend', onUp);

  // Stage 3
  const s3 = document.getElementById('s3');
  s3.addEventListener('click', (e)=>{
    // Make a large stair region box on the right half (where stairs image is).
    const r = app.getBoundingClientRect();
    const stair = {left: r.width*0.58, top:r.height*0.20, right:r.width*0.92, bottom:r.height*0.90};
    const x = e.clientX, y = e.clientY;
    if(x>=stair.left && x<=stair.right && y>=stair.top && y<=stair.bottom){
      showCircleAt(x,y,1.0);
      playCorrect();
      hint.innerText = '모두 정답입니다!';
      hint.style.display='block';
      setTimeout(()=>hint.style.display='none', 1800);
    }
  }, {passive:true});

})();</script>
</body>
</html>
